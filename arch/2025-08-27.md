# boot 分区扩容

boot分区原先设置了500M，最近升级系统时报100%满了，因为我的boot目录下同时有initramfs-linux.img 和 initramfs-linux-zen.img 所以占用多一些。今天决定扩容到1G， 以下为扩容以后的效果和详细步骤（**务必先备份重要数据**）
```
$ sudo fdisk -l /dev/sda
Disk /dev/sda: 232.89 GiB, 250059350016 bytes, 488397168 sectors
Disk model: Samsung SSD 870
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xe6e48180

Device     Boot   Start       End   Sectors   Size Id Type
/dev/sda1  *       2048   2047999   2045952   999M  c W95 FAT32 (LBA)
/dev/sda2       2048000 488397167 486349168 231.9G 83 Linux
```

## 步骤 1：从 live 环境启动

检查 Arch Linux 系统是否使用 EFI 启动
```
 ls /sys/firmware/efi
```
如果命令输出了文件或目录（如 efivars），说明是 EFI 启动；若提示 "No such file or directory" 则为 BIOS 启动。经过测试我的系统是EFI启动，开始没检查使用 BIOS 启动Live-CD，修复完的系统出现了奇怪的问题。
 
使用 Arch Linux live USB/CD 启动电脑（步骤省略），如果原系统是 EFI 启动；同时U盘引导时如果有2个u盘项也要选择带UEFI标示的，不然安装grub时会报错 **EFI variables are not supported on this system**

## 步骤 2：备份原系统
注意：不可以使用cp来备份系统，推荐使用rsync备份
```
mount /dev/sda2 /mnt/temp/sda2
mount /dev/sda1 /mnt/temp/sda1
rsync -avH --progress /mnt/temp/sda2/ /mnt/external/sda2/
rsync -avH --progress /mnt/temp/sda1/ /mnt/external/sda1/
```
## 步骤 3: 判断磁盘类型
```
lsblk  # 列出所有磁盘和分区（如/dev/sda）
fdisk -l /dev/sda
```

通过 fdisk 输出的 "Disk label type" 判断磁盘类型，并选择工具调整分区大小：

* GPT 分区表：使用gdisk
* MBR 分区表：使用fdisk

## 步骤 4：如boot分区后面有未分配的磁盘空间可直接调整文件系统大小（未测试）
使用fdisk调整boot分区大小（步骤略）

然后根据 boot 分区的文件系统类型操作：
### 情况 1：文件系统为 ext4
1. 检查文件系统错误：
```
e2fsck -f /dev/sda1  # 替换为boot分区路径，-f强制检查
```
2. 扩容文件系统（自动匹配分区大小）：
```
resize2fs /dev/sda1
```
### 情况 2：文件系统为 vfat（EFI 系统分区）
1. 检查文件系统错误：
```
dosfsck -f /dev/sda1  # -f强制检查
```
2. 扩容文件系统（需先安装dosfstools）：
```
pacman -Sy dosfstools  # 在live环境安装工具
resize.vfat /dev/sda1  # 自动扩容到分区大小
```

## 步骤 5：如boot分区后无未分配空间, 可先调整分区
可以使用 parted 调整分区使boot分区后面有未分配空间，再进行步骤4

因为我操作parted最终失败，所以具体parted操作步骤不再列出。最后使用fdisk进行了重新分区和格式化（步骤6）

## 步骤 6：重新进行磁盘分区和格式化（实际测试）

因为从 fdisk 输出判断磁盘类型为MBR而非GPT，所以我用fdisk重建分区（具体步骤忽略）

其中修改boot文件系统为fat32步骤为：

1. 输入t来更改分区的类型。根据提示输入分区 ID 号，然后输入c来选择 FAT32 文件系统类型
2. mkfs.vfat -F 32 /dev/sda1 来格式化新创建的分区为 FAT32 文件系统

## 步骤 7: 恢复数据
```
mount /dev/sda2 /mnt/temp/sda2
mount /dev/sda1 /mnt/temp/sda1
rsync -avH --progress /mnt/external/sda2/ /mnt/temp/sda2/
rsync -avH --progress /mnt/external/sda1/ /mnt/temp/sda1/
umount /dev/sda2
umount /dev/sda1
```

## 步骤 8: 重新构建 GRUB 引导
```
mount /dev/sda2 /mnt/old_sys  # 根分区
mount /dev/sda1 /mnt/old_sys/boot  # /boot 分区（若有独立分区）
genfstab -U -p /mnt/old_sys > /mnt/old_sys/etc/fstab
arch-chroot /mnt/old_sys
```
因为我重新分区了，所以要更新fstab中的UUID

### 场景 1：使用 UEFI 引导模式（GPT 分区表）
```
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=grub
```
### 场景 2：使用 BIOS 引导模式
```
grub-install --recheck /dev/sda
```
最后执行
```
grub-mkconfig -o /boot/grub/grub.cfg
```
grub-mkconfig -o /boot/grub/grub.cfg
```
